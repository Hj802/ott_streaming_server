<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWM OTT Server</title>
    <style>
        /* [ÌÖåÎßà] Îã§ÌÅ¨ Î™®Îìú (Netflix Style) */
        :root {
            --primary-red: #e50914;
            --bg-black: #141414;
            --card-bg: #2f2f2f;
        }
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-black);
            color: #fff;
            margin: 0; padding: 0;
            overflow-x: hidden;
        }

        /* [Header] */
        header {
            background-color: #000;
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; top: 0; z-index: 100;
        }
        .logo { color: var(--primary-red); font-size: 28px; font-weight: bold; text-decoration: none; }
        .auth-btn {
            background-color: var(--primary-red);
            color: white; border: none;
            padding: 8px 16px; border-radius: 4px;
            cursor: pointer; font-weight: bold;
        }

        /* [Main Content] */
        .container { padding: 40px; max-width: 1200px; margin: 0 auto; display: none; /* Í∏∞Î≥∏ Ïà®ÍπÄ */ }
        
        #video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px; margin-top: 20px;
        }
        .video-card {
            background-color: var(--card-bg);
            border-radius: 6px; overflow: hidden;
            transition: transform 0.3s; cursor: pointer;
            position: relative;
        }
        .video-card:hover { transform: scale(1.05); z-index: 10; }
        
        .thumbnail { 
            width: 100%; height: 130px; 
            background-color: #333; object-fit: cover; display: block; 
        }

        /* Ïù¥Ïñ¥Î≥¥Í∏∞ ÏßÑÌñâÎ•† Î∞î (ÏÑ†ÌÉù ÏÇ¨Ìï≠ UI) */
        .progress-bar {
            height: 3px; background: #555; width: 100%;
            position: absolute; bottom: 60px; /* info ÏúÑÏ™Ω */
        }
        .progress-fill {
            height: 100%; background: var(--primary-red); width: 0%;
        }

        .info { padding: 12px; }
        .title { font-weight: bold; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* [Login Modal] */
        #login-modal {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .login-box {
            background: rgba(0,0,0,0.85);
            padding: 60px 68px 40px;
            border-radius: 4px;
            width: 100%; max-width: 320px;
            text-align: center;
        }
        .login-input {
            width: 100%; padding: 16px; margin-bottom: 16px;
            border-radius: 4px; border: none; background: #333; color: white;
            box-sizing: border-box;
        }
        .login-submit {
            width: 100%; padding: 16px;
            border-radius: 4px; border: none;
            background: var(--primary-red); color: white;
            font-weight: bold; cursor: pointer; margin-top: 10px;
        }

        /* [Player Modal] */
        #player-overlay {
            display: none;
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: black; z-index: 2000;
            justify-content: center; align-items: center; flex-direction: column;
        }
        video { width: 90%; max-width: 1000px; outline: none; }
        .close-player {
            position: absolute; top: 20px; right: 30px;
            color: white; font-size: 40px; cursor: pointer;
        }
    </style>
</head>
<body>

    <header>
        <a href="#" class="logo">SWM OTT</a>
        <button id="logout-btn" class="auth-btn" style="display:none" onclick="handleLogout()">Logout</button>
    </header>

    <div id="login-modal">
        <div class="login-box">
            <h2 style="margin-bottom:30px">Sign In</h2>
            <form onsubmit="handleAuth(event)">
                <input type="text" id="username" class="login-input" placeholder="Username" required>
                <input type="password" id="password" class="login-input" placeholder="Password" required>
                <div style="display:flex; gap:10px;">
                    <button type="submit" class="login-submit" onclick="setMode('login')">Sign In</button>
                    <button type="submit" class="login-submit" onclick="setMode('register')" style="background-color:#444;">Sign Up</button>
                </div>
            </form>
            <p id="login-error" style="color: #e87c03; display: none; margin-top: 15px; font-size: 14px;"></p>
        </div>
    </div>

    <div id="main-content" class="container">
        <h2>üî• Trending Now</h2>
        <div id="video-grid"></div>
    </div>

    <div id="player-overlay">
        <div class="close-player" onclick="closePlayer()">&times;</div>
        <video id="main-player" controls>
            <source src="" type="video/mp4">
        </video>
    </div>

    <script>
        const API_VIDEOS = '/api/videos';
        const API_LOGIN = '/login';
        const API_LOGOUT = '/logout';
        const API_REGISTER = '/register';
        const API_HISTORY = '/api/history'; // [Ï∂îÍ∞Ä]

        let authMode = 'login';
        
        // [Ïù¥Ïñ¥Î≥¥Í∏∞ Í¥ÄÎ†® Î≥ÄÏàò]
        let currentVideoId = null;
        let historyTimer = null;

        function setMode(mode) { authMode = mode; }

        document.addEventListener('DOMContentLoaded', () => {
            checkLoginState();
        });

        async function checkLoginState() {
            try {
                const response = await fetch(API_VIDEOS);
                if (response.status === 200) {
                    const videos = await response.json();
                    showApp(videos);
                } else if (response.status === 401 || response.status === 403) {
                    showLogin();
                }
            } catch (e) { console.error(e); }
        }

        function showLogin() {
            document.getElementById('login-modal').style.display = 'flex';
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('logout-btn').style.display = 'none';
        }

        function showApp(videos) {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            document.getElementById('logout-btn').style.display = 'block';
            renderVideos(videos);
        }

        async function handleAuth(e) {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const errorMsg = document.getElementById('login-error');
            const endpoint = (authMode === 'login') ? API_LOGIN : API_REGISTER;

            try {
                const bodyData = `username=${user}&password=${pass}`;
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: bodyData
                });
                const result = await response.json();

                if (result.success) {
                    if (authMode === 'register') {
                        alert("Sign Up Successful! Please Log In.");
                    } else {
                        errorMsg.style.display = 'none';
                        checkLoginState(); 
                    }
                } else {
                    errorMsg.innerText = result.message || "Operation Failed";
                    errorMsg.style.display = 'block';
                }
            } catch (err) {
                console.error(err);
                errorMsg.innerText = "Connection Error";
                errorMsg.style.display = 'block';
            }
        }

        async function handleLogout() {
            await fetch(API_LOGOUT, { method: 'POST' });
            location.reload(); 
        }

        function renderVideos(videos) {
            const grid = document.getElementById('video-grid');
            grid.innerHTML = '';
            
            videos.forEach(v => {
                const card = document.createElement('div');
                card.className = 'video-card';
                
                // [ÏàòÏ†ï] openPlayerÏóê IDÏôÄ last_posÎ•º Ï†ÑÎã¨
                // v.last_posÍ∞Ä ÏóÜÏúºÎ©¥ 0ÏúºÎ°ú Ï≤òÎ¶¨
                const lastPos = v.last_pos || 0;
                card.onclick = () => openPlayer(v.url, v.id, lastPos);
                
                const thumbSrc = v.thumbnail ? v.thumbnail : '';
                
                // [UI] ÏãúÏ≤≠ Î∞î ÌëúÏãú (ÏÑ†ÌÉùÏÇ¨Ìï≠)
                let progressHtml = '';
                if (v.duration > 0 && lastPos > 0) {
                    const pct = Math.min((lastPos / v.duration) * 100, 100);
                    progressHtml = `<div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>`;
                }

                card.innerHTML = `
                    <img class="thumbnail" src="${thumbSrc}" onerror="this.style.display='none'">
                    ${progressHtml}
                    <div class="info">
                        <div class="title">${v.title}</div>
                        <div style="font-size:12px; color:#aaa">
                            ${lastPos > 0 ? 'Resuming at ' + formatTime(lastPos) : 'Duration: ' + v.duration + 's'}
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        const playerModal = document.getElementById('player-overlay');
        const videoEl = document.getElementById('main-player');

        // [ÌïµÏã¨] Ïù¥Ïñ¥Î≥¥Í∏∞ Î∞è Í∏∞Î°ù Ï†ÄÏû• Î°úÏßÅ
        function openPlayer(url, videoId, startTime) {
            currentVideoId = videoId;
            videoEl.src = url;
            
            // 1. Ïù¥Ïñ¥Î≥¥Í∏∞ ÏúÑÏπò ÏÑ§Ï†ï
            // Î©îÌÉÄÎç∞Ïù¥ÌÑ∞Í∞Ä Î°úÎìúÎêú ÌõÑ ÏãúÍ∞ÑÏùÑ ÏÑ§Ï†ïÌï¥Ïïº ÏïàÏ†ÑÌï®
            videoEl.onloadedmetadata = () => {
                if (startTime > 0) {
                    videoEl.currentTime = startTime;
                    console.log(`Resuming video ${videoId} at ${startTime}s`);
                }
                videoEl.play().catch(e => console.log('Autoplay blocked'));
            };

            playerModal.style.display = 'flex';

            // 2. 5Ï¥àÎßàÎã§ ÏãúÏ≤≠ Í∏∞Î°ù Ï†ÑÏÜ° (Heartbeat)
            if (historyTimer) clearInterval(historyTimer);
            historyTimer = setInterval(sendHistory, 5000); 
        }

        function closePlayer() {
            videoEl.pause();
            videoEl.src = "";
            playerModal.style.display = 'none';
            
            // ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨
            if (historyTimer) clearInterval(historyTimer);
            historyTimer = null;
            
            // Îã´ÏùÑ Îïå ÎßàÏßÄÎßâÏúºÎ°ú Ìïú Î≤à Îçî Ï†ÄÏû• (ÏÑ†ÌÉù ÏÇ¨Ìï≠)
            sendHistory();
            currentVideoId = null;

            // Î™©Î°ùÏùÑ Í∞±Ïã†Ìï¥ÏÑú ÏßÑÌñâÎ•† Î∞î ÏóÖÎç∞Ïù¥Ìä∏
            checkLoginState();
        }

        // ÏÑúÎ≤ÑÎ°ú ÏúÑÏπò Ï†ÑÏÜ°
        async function sendHistory() {
            if (!currentVideoId || videoEl.paused || videoEl.ended) return;

            const currentTime = Math.floor(videoEl.currentTime);
            // 0Ï¥àÍ±∞ÎÇò ÎÑàÎ¨¥ ÏßßÏúºÎ©¥ Ìå®Ïä§ (ÏÑ†ÌÉù ÏÇ¨Ìï≠)
            if (currentTime < 1) return;

            try {
                const bodyData = `video_id=${currentVideoId}&timestamp=${currentTime}`;
                await fetch(API_HISTORY, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: bodyData
                });
                // console.log(`Saved history: ${currentTime}s`);
            } catch (e) {
                console.error("Failed to save history", e);
            }
        }

        // ÏãúÍ∞Ñ Ìè¨Îß∑ÌåÖ Ìó¨Ìçº (Ï¥à -> 00:00)
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s < 10 ? '0'+s : s}`;
        }
    </script>
</body>
</html>